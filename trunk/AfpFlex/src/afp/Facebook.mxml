<?xml version="1.0" encoding="utf-8"?>
<s:WindowedApplication xmlns:fx="http://ns.adobe.com/mxml/2009" xmlns:s="library://ns.adobe.com/flex/spark"
	xmlns:mx="library://ns.adobe.com/flex/mx" creationComplete="_init()">
	<fx:Declarations>
		<!-- Placer ici les éléments non visuels (services et objets de valeur, par exemple). -->
	</fx:Declarations>
	<fx:Script>
		<![CDATA[
			import alamboley.utils.PrintR;

			import com.facebook.graph.FacebookDesktop;

			import mx.collections.ArrayCollection;

			private var _images : ArrayCollection = new ArrayCollection();
			private var _nbAlbumToCreate : uint;

			private function _init() : void
			{
				FacebookDesktop.init("206351602768348", _handleLogin);
			}

			private function _handleLogin(session : Object, fail : Object) : void
			{
				if (session != null)
				{
					userImage.source = FacebookDesktop.getImageUrl(session.uid, 'large');
					userName.text = session.user.name;
				}
			}

			protected function facebookBTN_clickHandler(event : MouseEvent) : void
			{
				FacebookDesktop.login(_handleLogin, ["user_photos, publish_stream"]);
			}

			protected function onSaveToPhotoAlbumClicked(event : MouseEvent) : void
			{
				var bitmapData : BitmapData = new BitmapData(userImage.width, userImage.height);
				bitmapData.draw(userImage);
				var bitmap : Bitmap = new Bitmap(bitmapData);

				var params : Object = {image:bitmap, message:'Event 37', fileName:'FILE_NAME'};
				FacebookDesktop.api('me/photos', onSaveToPhotoAlbumComplete, params);
			}

			protected function onSaveToPhotoAlbumComplete(result : Object, fail : Object) : void
			{
				PrintR.pr(result);
			}

			protected function _createAlbums(event : MouseEvent) : void
			{
				FacebookDesktop.api('me/albums', _createAlbumsCalback, {fields:'name'});
			}

			protected function _createAlbumsCalback(result : Object, fail : Object) : void
			{
				var albumsToCreate : Array = ['Event 37', 'Event 38', 'Event 39', 'Event 40'];
				var i : int;
				for each (var res:Object in result)
				{
					i = albumsToCreate.indexOf(res.name);
					if (i != -1)
						albumsToCreate.splice(i, 1);
				}
				_nbAlbumToCreate = albumsToCreate.length;
				if (_nbAlbumToCreate == 0) _touslesalbumsonetecrees();
				for each (var albumName : String in albumsToCreate)
				{
					FacebookDesktop.api('me/albums', onAlbumCreationComplete, {name:albumName, message:'Super c\'est l\'album ' + albumName + ' !'}, "POST");
				}
			}

			protected function onAlbumCreationComplete(result : Object, fail : Object) : void
			{
				_nbAlbumToCreate--;
				if (_nbAlbumToCreate == 0) _touslesalbumsonetecrees();
			}

			private function _touslesalbumsonetecrees() : void
			{
				trace('touslesalbumsonetecrees !');
			}
		]]>
	</fx:Script>
	<s:Button id="facebookBTN" x="10" y="67" label="Connexion à Facebook"
		click="facebookBTN_clickHandler(event)"/>
	<s:Button id="uploadBTN" x="200" y="179" label="Uploader la photo"
		click="onSaveToPhotoAlbumClicked(event)"/>
	<s:Button id="checkAlbum" x="200" y="240" label="Créer tous les albums"
		click="_createAlbums(event)"/>
	<s:Image id="userImage" x="10" y="179"/>
	<s:Label id="userName" x="10" y="147" text="Label"/>
</s:WindowedApplication>
